# Regras e Padr√µes do Sistema Financeiro Empresarial

## üìã VIS√ÉO GERAL DO PROJETO

Este √© um sistema financeiro empresarial desenvolvido em PHP puro com arquitetura MVC customizada. O sistema gerencia empresas, usu√°rios, fornecedores, clientes, contas a pagar/receber, fluxo de caixa, relat√≥rios financeiros e integra√ß√µes.

## üèóÔ∏è ARQUITETURA

### Estrutura de Diret√≥rios
```
/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core/           # Classes base (App, Router, Controller, Model, Database, Session, Request, Response)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/    # Controllers (um por m√≥dulo)
‚îÇ   ‚îú‚îÄ‚îÄ models/         # Models (um por entidade)
‚îÇ   ‚îú‚îÄ‚îÄ views/          # Views organizadas por m√≥dulo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layouts/    # Layouts principais (main.php, auth.php)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/ # Componentes reutiliz√°veis (sidebar.php)
‚îÇ   ‚îî‚îÄ‚îÄ middleware/     # Middlewares (AuthMiddleware, etc)
‚îú‚îÄ‚îÄ config/             # Configura√ß√µes (routes.php, database.php, constants.php)
‚îú‚îÄ‚îÄ includes/           # Classes auxiliares (Migration, MigrationManager, EnvLoader)
‚îú‚îÄ‚îÄ migrations/         # Migrations do banco de dados
‚îú‚îÄ‚îÄ public/             # Arquivos p√∫blicos (index.php, assets/)
‚îî‚îÄ‚îÄ .env                # Vari√°veis de ambiente
```

### Padr√£o MVC Customizado
- **Models**: Estendem `App\Core\Model`, cont√™m l√≥gica de neg√≥cio e acesso a dados
- **Controllers**: Estendem `App\Core\Controller`, recebem `Request` e `Response` como par√¢metros
- **Views**: PHP puro com HTML/TailwindCSS, acessam dados via `$this->session` e vari√°veis extra√≠das

## üìù CONVEN√á√ïES DE NOMENCLATURA

### Classes
- **Controllers**: `{Nome}Controller.php` (ex: `EmpresaController.php`, `UsuarioController.php`)
- **Models**: `{Nome}.php` no singular (ex: `Empresa.php`, `Usuario.php`, `Fornecedor.php`)
- **Migrations**: `{numero}_{descricao}.php` (ex: `001_create_empresas.php`)

### M√©todos
- **Controllers**: `index`, `create`, `store`, `show`, `edit`, `update`, `destroy`
- **Models**: `findAll()`, `findById()`, `create()`, `update()`, `delete()`
- **Valida√ß√£o**: M√©todo `validate()` sempre `protected`, nunca `private`

### Rotas
- **Padr√£o RESTful**: `/recurso`, `/recurso/create`, `/recurso/{id}`, `/recurso/{id}/edit`, `/recurso/{id}/delete`
- **Rotas no arquivo**: `config/routes.php` com formato `'METHOD /rota' => ['handler' => 'Controller@method', 'middleware' => ['AuthMiddleware']]`

## üé® PADR√ïES DE VIEWS

### Estrutura de Views
```php
<div class="max-w-{tamanho} mx-auto">
    <!-- Header com t√≠tulo e bot√£o de a√ß√£o -->
    <!-- Formul√°rio ou Tabela -->
    <!-- Bot√µes de a√ß√£o -->
</div>
```

### Tema Dark/Light
- **Sempre usar**: Classes Tailwind com variantes `dark:` para tema escuro
- **Exemplo**: `bg-white dark:bg-gray-800`, `text-gray-900 dark:text-gray-100`
- **Background**: Definido no `main.php`, views N√ÉO devem ter `min-h-screen` ou backgrounds pr√≥prios
- **Tema aplicado**: Via `theme.js` que adiciona classe `dark` no `<html>`

### Formul√°rios
- **Campos obrigat√≥rios**: Marcados com `*` e atributo `required`
- **Valida√ß√£o**: HTML5 (`pattern`, `minlength`, `maxlength`) + valida√ß√£o server-side
- **M√°scaras**: Usar `data-mask="cnpj"`, `data-mask="cpf"`, etc. (suportado por `masks.js`)
- **Busca CEP**: Adicionar `data-cep` e `data-cep-prefix` no campo CEP para busca autom√°tica
  - Formato com array: `data-cep-prefix="endereco["` para `name="endereco[cep]"`
  - Formato direto: `data-cep-prefix=""` para `name="cep"`
- **Erros**: Exibidos abaixo do campo usando `$this->session->get('errors')['campo']`
- **Old values**: Recuperados via `$this->session->get('old')['campo']`
- **Limpar sess√£o**: Sempre limpar `old` e `errors` no final da view com `$this->session->delete()`

### Tabelas
- **Header**: Gradiente `bg-gradient-to-r from-blue-600 to-indigo-600`
- **Linhas**: Hover com `hover:bg-gray-50 dark:hover:bg-gray-700/50`
- **A√ß√µes**: √çcones SVG com cores sem√¢nticas (azul=ver, amarelo=editar, vermelho=excluir)

## üîê SEGURAN√áA E VALIDA√á√ÉO

### Valida√ß√£o de Dados
- **Client-side**: HTML5 validation + JavaScript (`masks.js`)
- **Server-side**: M√©todo `validate()` no Controller (sempre `protected`)
- **Mensagens de erro**: Armazenadas em `$this->session->set('errors', $errors)`
- **Dados antigos**: Armazenados em `$this->session->set('old', $data)`

### Autentica√ß√£o
- **Middleware**: `AuthMiddleware` aplicado em todas as rotas protegidas
- **Sess√£o**: Gerenciada por `App\Core\Session`
- **Verifica√ß√£o**: `isset($_SESSION['usuario_id'])` ou `$this->isAuthenticated()`

### Permiss√µes
- **Model**: `App\Models\Permissao` com m√©todos `hasPermission()`, `saveBatch()`
- **Estrutura**: `usuario_id`, `modulo`, `acao` (visualizar, criar, editar, excluir), `empresa_id`
- **M√≥dulos**: Definidos em `Permissao::MODULOS` e `Permissao::ACOES`
- **Formul√°rio**: Checkboxes organizados por m√≥dulo e a√ß√£o

## üíæ BANCO DE DADOS

### Migrations
- **Classe base**: `includes\Migration`
- **M√©todos obrigat√≥rios**: `up()` e `down()`
- **M√©todos auxiliares**: `createTable()`, `addColumn()`, `addIndex()`, `execute()`
- **Nomenclatura**: `{numero}_{descricao}.php` (ex: `004_create_permissoes.php`)
- **Execu√ß√£o**: Via `php migrate.php up` ou `php migrate.php status`

### Soft Delete
- **Padr√£o**: Usar campo `ativo BOOLEAN DEFAULT 1`
- **Exclus√£o**: `UPDATE tabela SET ativo = 0 WHERE id = :id`
- **Queries**: Sempre filtrar por `WHERE ativo = 1` em `findAll()`

### Relacionamentos
- **Foreign Keys**: Sempre definir `ON DELETE CASCADE` ou `ON DELETE SET NULL`
- **JSON**: Usar tipo `JSON` para campos complexos (ex: `endereco`, `configuracoes`)
- **√çndices**: Criar √≠ndices para campos frequentemente consultados

## üéØ PADR√ïES DE C√ìDIGO

### Controllers
```php
<?php
namespace App\Controllers;

use App\Core\Controller;
use App\Core\Request;
use App\Core\Response;
use App\Models\{Model};

class {Nome}Controller extends Controller
{
    private ${model}Model;
    
    public function index(Request $request, Response $response)
    {
        // Buscar dados
        // Renderizar view
    }
    
    protected function validate($data, $id = null)
    {
        $errors = [];
        // Valida√ß√µes
        return $errors;
    }
}
```

### Models
```php
<?php
namespace App\Models;

use App\Core\Model;
use App\Core\Database;
use PDO;

class {Nome} extends Model
{
    protected $table = '{tabela}';
    protected $db;
    
    public function __construct()
    {
        parent::__construct();
        $this->db = Database::getInstance()->getConnection();
    }
    
    public function findAll($empresaId = null)
    {
        // Query com filtro opcional
        // Retornar array vazio se n√£o houver resultados: ?: []
    }
}
```

### Views
```php
<?php
// Sempre usar htmlspecialchars() para output
<?= htmlspecialchars($variavel) ?>

// Acessar sess√£o
<?= $this->session->get('old')['campo'] ?? '' ?>
<?= isset($this->session->get('errors')['campo']) ? 'border-red-500' : '' ?>

// Limpar sess√£o no final
<?php 
$this->session->delete('old');
$this->session->delete('errors');
?>
```

## üé® PADR√ïES DE UI/UX

### Cores e Estilos
- **Prim√°ria**: Azul (`blue-600`) para Indigo (`indigo-600`)
- **Sucesso**: Verde (`green-600`)
- **Erro**: Vermelho (`red-600`)
- **Aviso**: Amarelo (`amber-600`)
- **Gradientes**: Usar `bg-gradient-to-r from-{cor1} to-{cor2}`

### Componentes
- **Cards**: `bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700`
- **Bot√µes prim√°rios**: `bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700`
- **Inputs**: `px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700`
- **Focus**: `focus:ring-2 focus:ring-blue-500 focus:border-transparent`

### √çcones
- **Usar SVG inline**: Sempre incluir `fill="none" stroke="currentColor" viewBox="0 0 24 24"`
- **Tamanhos padr√£o**: `w-5 h-5` para √≠cones pequenos, `w-6 h-6` para m√©dios

## üì¶ ASSETS E SCRIPTS

### JavaScript
- **Localiza√ß√£o**: `public/assets/js/`
- **Caminho absoluto**: Usar `/assets/js/{arquivo}.js` (n√£o caminho relativo)
- **M√°scaras**: `masks.js` com fun√ß√µes para CPF, CNPJ, telefone, CEP, etc.
- **Tema**: `theme.js` gerencia tema light/dark/system
- **CEP**: `cep.js` integra√ß√£o com API ViaCEP para busca autom√°tica de endere√ßos
  - Adicionar `data-cep` e `data-cep-prefix` no campo CEP
  - Suporta formatos: `endereco[cep]` e `cep` (sem prefixo)
  - Preenche automaticamente: logradouro, bairro, cidade, estado

### CSS
- **Framework**: TailwindCSS via CDN (desenvolvimento)
- **Fontes**: Inter via Google Fonts
- **Customiza√ß√£o**: Via `tailwind.config` no `<head>`

## üîÑ FLUXO DE DADOS

### Request ‚Üí Controller ‚Üí Model ‚Üí Database
1. **Request**: Dados chegam via `Request::all()` ou `Request::get()`
2. **Valida√ß√£o**: Controller chama `validate()` antes de processar
3. **Model**: Controller instancia Model e chama m√©todos (`create()`, `update()`, etc)
4. **Database**: Model usa PDO com prepared statements
5. **Response**: Controller redireciona ou renderiza view

### Sess√£o e Flash Messages
- **Sucesso**: `$_SESSION['success']` ou `$this->session->set('success', 'mensagem')`
- **Erro**: `$_SESSION['error']` ou `$this->session->set('error', 'mensagem')`
- **Exibi√ß√£o**: No layout `main.php` antes do conte√∫do
- **Limpeza**: Ap√≥s exibir, usar `unset($_SESSION['success'])` ou `$this->session->delete()`

## üå≥ ESTRUTURAS HIER√ÅRQUICAS

### Categorias Financeiras e Centros de Custo
- **Campo pai**: `categoria_pai_id` ou `centro_pai_id` (FK para mesma tabela)
- **M√©todos**: `buildTree()`, `getPath()`, `canBeParent()` (evita loops)
- **Views**: Suportar visualiza√ß√£o em lista (`flat`) e √°rvore (`tree`)
- **Valida√ß√£o**: Impedir que um item seja pai de si mesmo ou de seus descendentes

## üìã CHECKLIST PARA NOVOS M√ìDULOS

Ao criar um novo m√≥dulo, garantir:

- [ ] **Migration**: Criar migration com estrutura da tabela
- [ ] **Model**: Criar Model com m√©todos CRUD b√°sicos
- [ ] **Controller**: Criar Controller com m√©todos `index`, `create`, `store`, `show`, `edit`, `update`, `destroy`
- [ ] **Views**: Criar `index.php`, `create.php`, `edit.php`, `show.php`
- [ ] **Rotas**: Adicionar rotas em `config/routes.php` com middleware `AuthMiddleware`
- [ ] **Sidebar**: Adicionar link no `sidebar.php` se necess√°rio
- [ ] **Valida√ß√£o**: Implementar m√©todo `validate()` como `protected`
- [ ] **Permiss√µes**: Adicionar m√≥dulo em `Permissao::MODULOS` se necess√°rio
- [ ] **Soft Delete**: Usar campo `ativo` e filtrar em `findAll()`
- [ ] **Tema Dark**: Garantir suporte completo ao tema dark
- [ ] **M√°scaras**: Aplicar m√°scaras apropriadas nos campos (CPF, CNPJ, telefone, etc)

## ‚ö†Ô∏è REGRAS IMPORTANTES

1. **NUNCA** usar `private` para m√©todos `validate()` - sempre `protected`
2. **SEMPRE** usar `htmlspecialchars()` para output de dados do usu√°rio
3. **SEMPRE** usar prepared statements (PDO) - nunca concatenar SQL
4. **SEMPRE** filtrar por `ativo = 1` em queries `findAll()`
5. **SEMPRE** retornar array vazio `?: []` quando n√£o houver resultados
6. **SEMPRE** limpar `old` e `errors` da sess√£o ap√≥s exibir nas views
7. **NUNCA** colocar `min-h-screen` ou backgrounds nas views individuais
8. **SEMPRE** usar caminhos absolutos para assets (`/assets/js/...`)
9. **SEMPRE** incluir valida√ß√£o client-side (HTML5) e server-side
10. **SEMPRE** usar `Request` e `Response` como par√¢metros nos m√©todos do Controller

## üöÄ COMANDOS √öTEIS

```bash
# Executar migrations
php migrate.php up
php migrate.php status

# Verificar tabelas no banco
php check_tables.php
```

## üìö REFER√äNCIAS

- **Documenta√ß√£o completa**: `DOCUMENTACAO_COMPLETA.md`
- **An√°lise de implementa√ß√£o**: `ANALISE_IMPLEMENTACAO.md`
- **Changelog**: `CHANGELOG.md`

---

**√öltima atualiza√ß√£o**: Baseado na implementa√ß√£o dos m√≥dulos Empresas, Usu√°rios, Fornecedores, Clientes, Categorias Financeiras, Centros de Custo e Formas de Pagamento.

